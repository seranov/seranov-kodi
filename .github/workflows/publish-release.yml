name: Publish Kodi Repository

# –¢—Ä–∏–≥–≥–µ—Ä—ã / Triggers
on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

# –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è GitHub Pages / Permissions for GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

# –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–µ–ø–ª–æ–µ–≤ / Prevent concurrent deployments
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    name: Build and Deploy Repository
    runs-on: ubuntu-latest
    
    steps:
      # –®–∞–≥ 1: Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è / Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python / Step 2: Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'  # Minimum version for Path.is_relative_to()

      # –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π / Step 3: Create directory structure
      - name: Create output directories
        run: |
          echo "Creating output directory structure..."
          mkdir -p docs
          
          # –°–ø–∏—Å–æ–∫ –∞–¥–¥–æ–Ω–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ / List of addons to process
          ADDONS=(
            "context.screenshots"
            "plugin.video.random.recursive"
            "plugin.video.unified.browser"
            "service.seranov.nfoscanner"
            "repository.seranov"
          )
          
          # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–¥–¥–æ–Ω–∞ / Create subdirectories for each addon
          for addon in "${ADDONS[@]}"; do
            mkdir -p "docs/$addon"
            echo "Created directory: docs/$addon"
          done

      # –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ ZIP-–∞—Ä—Ö–∏–≤–æ–≤ / Step 4: Create ZIP archives
      - name: Create addon ZIP archives
        run: |
          echo "Creating ZIP archives for addons..."
          
          # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è ZIP –∞—Ä—Ö–∏–≤–∞ / Function to create ZIP archive
          create_addon_zip() {
            local addon_dir="$1"
            local addon_id
            addon_id=$(basename "$addon_dir")
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è addon.xml / Check if addon.xml exists
            if [ ! -f "$addon_dir/addon.xml" ]; then
              echo "Warning: $addon_dir/addon.xml not found, skipping..."
              return
            fi
            
            # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –∏–∑ addon.xml / Extract version from addon.xml
            local version
            version=$(python3 -c 'import xml.etree.ElementTree as ET; import sys; tree = ET.parse(sys.argv[1]); root = tree.getroot(); print(root.get("version"))' "$addon_dir/addon.xml")
            
            echo "Processing $addon_id version $version..."
            
            # –°–æ–∑–¥–∞–Ω–∏–µ ZIP –∞—Ä—Ö–∏–≤–∞ / Create ZIP archive
            local zip_name="${addon_id}-${version}.zip"
            local zip_path="docs/${addon_id}/${zip_name}"
            
            # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∞—Ä—Ö–∏–≤–∞ –µ—Å–ª–∏ –µ—Å—Ç—å / Remove old archive if exists
            rm -f "$zip_path"
            
            # –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ / Create temporary directory
            local temp_dir
            temp_dir=$(mktemp -d)
            mkdir -p "$temp_dir/$addon_id"
            
            # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∞–¥–¥–æ–Ω–∞ (–∏—Å–∫–ª—é—á–∞—è —Å–∫—Ä—ã—Ç—ã–µ —Ñ–∞–π–ª—ã –∏ __pycache__) 
            # Copy addon files (excluding hidden files and __pycache__)
            rsync -a --exclude='.*' --exclude='__pycache__' --exclude='*.pyc' "$addon_dir/" "$temp_dir/$addon_id/"
            
            # –°–æ–∑–¥–∞–Ω–∏–µ ZIP –∞—Ä—Ö–∏–≤–∞ / Create ZIP archive
            cd "$temp_dir" || exit 1
            zip -q -r "$zip_name" "$addon_id" -x "*/\.*" "*/__pycache__/*" "*.pyc"
            mv "$zip_name" "$GITHUB_WORKSPACE/$zip_path"
            cd "$GITHUB_WORKSPACE" || exit 1
            
            # –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ / Clean up temporary directory
            rm -rf "$temp_dir"
            
            echo "Created: $zip_path"
            
            # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ icon.png –µ—Å–ª–∏ –µ—Å—Ç—å / Copy icon.png if exists
            if [ -f "$addon_dir/icon.png" ]; then
              cp "$addon_dir/icon.png" "docs/$addon_id/"
              echo "Copied icon.png for $addon_id"
            fi
            
            # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ fanart.jpg –µ—Å–ª–∏ –µ—Å—Ç—å / Copy fanart.jpg if exists
            if [ -f "$addon_dir/fanart.jpg" ]; then
              cp "$addon_dir/fanart.jpg" "docs/$addon_id/"
              echo "Copied fanart.jpg for $addon_id"
            fi
          }
          
          # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –∞–¥–¥–æ–Ω–æ–≤ / Process all addon directories
          for addon_dir in plugin.* service.* context.* repository.*; do
            if [ -d "$addon_dir" ]; then
              create_addon_zip "$addon_dir"
            fi
          done
          
          echo "All ZIP archives created successfully!"

      # –®–∞–≥ 5: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è addons.xml / Step 5: Generate addons.xml
      - name: Generate addons.xml
        run: |
          echo "Generating addons.xml..."
          
          python3 << 'PYTHON_SCRIPT'
          import xml.etree.ElementTree as ET
          from pathlib import Path
          import sys
          
          def indent_xml(elem, level=0):
              """Add pretty-printing indentation to XML"""
              indent = "\n" + "    " * level
              if len(elem):
                  if not elem.text or not elem.text.strip():
                      elem.text = indent + "    "
                  if not elem.tail or not elem.tail.strip():
                      elem.tail = indent
                  for child in elem:
                      indent_xml(child, level + 1)
                  if len(elem) > 0:
                      last_child = elem[-1]
                      if not last_child.tail or not last_child.tail.strip():
                          last_child.tail = indent
              else:
                  if level and (not elem.tail or not elem.tail.strip()):
                      elem.tail = indent
          
          # –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ / Create root element
          root = ET.Element('addons')
          
          # –°–ø–∏—Å–æ–∫ –∞–¥–¥–æ–Ω–æ–≤ / List of addons
          addon_dirs = []
          base_path = Path('.')
          
          for item in base_path.iterdir():
              if item.is_dir() and (
                  item.name.startswith('plugin.') or 
                  item.name.startswith('service.') or 
                  item.name.startswith('context.') or 
                  item.name.startswith('repository.')
              ):
                  addon_xml = item / 'addon.xml'
                  if addon_xml.exists():
                      addon_dirs.append(item)
          
          print(f"Found {len(addon_dirs)} addons")
          
          # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –∞–¥–¥–æ–Ω–∞ –≤ addons.xml / Add each addon to addons.xml
          for addon_dir in sorted(addon_dirs):
              try:
                  tree = ET.parse(addon_dir / 'addon.xml')
                  addon_element = tree.getroot()
                  root.append(addon_element)
                  print(f"Added {addon_element.get('id')} version {addon_element.get('version')}")
              except Exception as e:
                  print(f"Error processing {addon_dir}: {e}", file=sys.stderr)
                  sys.exit(1)
          
          # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ / Format and save
          indent_xml(root)
          tree = ET.ElementTree(root)
          
          output_path = Path('docs/addons.xml')
          tree.write(output_path, encoding='utf-8', xml_declaration=True)
          
          print(f"Generated: {output_path}")
          PYTHON_SCRIPT
          
          echo "addons.xml generated successfully!"

      # –®–∞–≥ 6: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è addons.xml.md5 / Step 6: Generate addons.xml.md5
      - name: Generate addons.xml.md5
        run: |
          echo "Generating addons.xml.md5..."
          
          cd docs
          md5sum addons.xml | awk '{print $1}' > addons.xml.md5
          
          echo "MD5 checksum: $(cat addons.xml.md5)"
          echo "addons.xml.md5 generated successfully!"

      # –®–∞–≥ 7: –°–æ–∑–¥–∞–Ω–∏–µ .nojekyll –∏ index.html / Step 7: Create .nojekyll and index.html
      - name: Create .nojekyll and index.html
        run: |
          echo "Creating .nojekyll file..."
          touch docs/.nojekyll
          echo ".nojekyll file created!"
          
          echo "Creating index.html..."
          cat > docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Seranov Kodi Repository</title>
              <style>
                  body {
                      font-family: Arial, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      background-color: #f5f5f5;
                  }
                  .container {
                      background-color: white;
                      padding: 30px;
                      border-radius: 10px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                  }
                  h1 {
                      color: #333;
                      border-bottom: 3px solid #007bff;
                      padding-bottom: 10px;
                  }
                  h2 {
                      color: #555;
                      margin-top: 30px;
                  }
                  code {
                      background-color: #f4f4f4;
                      padding: 2px 6px;
                      border-radius: 3px;
                      font-family: monospace;
                  }
                  .repo-url {
                      background-color: #e9ecef;
                      padding: 15px;
                      border-radius: 5px;
                      margin: 20px 0;
                      word-break: break-all;
                  }
                  ol {
                      line-height: 1.8;
                  }
                  .addon-list {
                      background-color: #f8f9fa;
                      padding: 15px;
                      border-radius: 5px;
                      margin: 20px 0;
                  }
                  .addon-list ul {
                      list-style-type: none;
                      padding-left: 0;
                  }
                  .addon-list li {
                      padding: 5px 0;
                  }
                  a {
                      color: #007bff;
                      text-decoration: none;
                  }
                  a:hover {
                      text-decoration: underline;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üé¨ Seranov Kodi Repository</h1>
                  
                  <p>Welcome to the Seranov Kodi Add-ons Repository!</p>
                  
                  <h2>üì¶ Installation</h2>
                  <ol>
                      <li>Download the repository ZIP file: <a href="repository.seranov/repository.seranov-1.0.0.zip">repository.seranov-1.0.0.zip</a></li>
                      <li>In Kodi, go to <strong>Add-ons ‚Üí Install from zip file</strong></li>
                      <li>Select the downloaded <code>repository.seranov-1.0.0.zip</code> file</li>
                      <li>Wait for the "Add-on enabled" notification</li>
                      <li>Now you can install add-ons from this repository via <strong>Install from repository ‚Üí Seranov Repository</strong></li>
                  </ol>
                  
                  <h2>üîó Repository URL</h2>
                  <div class="repo-url">
                      <strong>Direct Repository URL:</strong><br>
                      <code>https://seranov.github.io/seranov-kodi/</code>
                  </div>
                  
                  <h2>üìã Available Add-ons</h2>
                  <div class="addon-list">
                      <ul>
                          <li>üì∏ <strong>Context Screenshots</strong> - Take screenshots from context menu</li>
                          <li>üé≤ <strong>Random Recursive Video Player</strong> - Play random videos from your library</li>
                          <li>üé• <strong>Unified Browser</strong> - Browse your video collection</li>
                          <li>üîç <strong>NFO Scanner Service</strong> - Automatic NFO file scanning service</li>
                      </ul>
                  </div>
                  
                  <h2>üìÑ Repository Files</h2>
                  <ul>
                      <li><a href="addons.xml">addons.xml</a> - Repository metadata</li>
                      <li><a href="addons.xml.md5">addons.xml.md5</a> - Checksum file</li>
                  </ul>
                  
                  <h2>üîß For Developers</h2>
                  <p>This repository is automatically built and deployed via GitHub Actions.</p>
                  <p>Source code: <a href="https://github.com/seranov/seranov-kodi">github.com/seranov/seranov-kodi</a></p>
              </div>
          </body>
          </html>
          EOF
          
          echo "index.html created successfully!"

      # –®–∞–≥ 8: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è index.html –¥–ª—è –∞–¥–¥–æ–Ω–æ–≤ / Step 8: Generate index.html for addons
      - name: Generate addon index pages
        run: |
          echo "Generating index.html pages for addon directories..."
          
          # –°–ø–∏—Å–æ–∫ –∞–¥–¥–æ–Ω–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ / List of addons to process
          ADDONS=(
            "context.screenshots"
            "plugin.video.random.recursive"
            "plugin.video.unified.browser"
            "service.seranov.nfoscanner"
            "repository.seranov"
          )
          
          for addon_id in "${ADDONS[@]}"; do
            if [ -d "docs/$addon_id" ]; then
              cat > "docs/$addon_id/index.html" << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>$addon_id</title>
          </head>
          <body>
              <h1>$addon_id</h1>
              <p><a href="../">Back to repository</a></p>
              <h2>Files:</h2>
              <ul>
          EOF
              
              # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ —Ñ–∞–π–ª—ã / Add links to files
              for file in docs/$addon_id/*; do
                if [ -f "$file" ]; then
                  filename=$(basename "$file")
                  if [ "$filename" != "index.html" ]; then
                    echo "        <li><a href=\"$filename\">$filename</a></li>" >> "docs/$addon_id/index.html"
                  fi
                fi
              done
              
              cat >> "docs/$addon_id/index.html" << EOF
              </ul>
          </body>
          </html>
          EOF
              
              echo "Created index.html for $addon_id"
            fi
          done
          
          echo "All index pages created successfully!"

      # –®–∞–≥ 9: –í—ã–≤–æ–¥ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ / Step 9: Display directory structure
      - name: Display output structure
        run: |
          echo "=== Output Directory Structure ==="
          tree -L 2 docs/ || find docs/ -maxdepth 2 -print
          echo ""
          echo "=== File sizes ==="
          du -h docs/* | sort -h

      # –®–∞–≥ 10: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Pages / Step 10: Configure GitHub Pages
      - name: Configure GitHub Pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Configuring GitHub Pages..."
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/pages \
            -d '{"source":{"branch":"gh-pages","path":"/"}}' \
            || echo "Pages might already be configured or error occurred"

      # –®–∞–≥ 11: Deploy –Ω–∞ GitHub Pages / Step 11: Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          force_orphan: true
          enable_jekyll: false
          commit_message: "Deploy Kodi repository ${{ github.sha }}"

      # –®–∞–≥ 12: –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å–ø–µ—à–Ω–æ–º –¥–µ–ø–ª–æ–µ / Step 12: Output deployment info
      - name: Deployment complete
        run: |
          echo "‚úÖ Deployment successful!"
          echo ""
          echo "Repository URL: https://seranov.github.io/seranov-kodi/"
          echo ""
          echo "To install in Kodi:"
          echo "1. Download repository.seranov ZIP from the releases"
          echo "2. In Kodi: Add-ons ‚Üí Install from zip file"
          echo "3. Select the downloaded repository.seranov-*.zip file"
          echo ""
          echo "Files deployed:"
          echo "  - addons.xml"
          echo "  - addons.xml.md5"
          echo "  - ZIP archives for all addons"
          echo "  - Icon files"
